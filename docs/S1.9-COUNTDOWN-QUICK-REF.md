# S1.9: Countdown & Time Utilities - Quick Reference

## ğŸ¯ What Was Built

Modular, reusable countdown and time synchronization system for Solana frontend with Â±1 second accuracy.

## ğŸ“¦ Files Created/Enhanced

### 1. **Time Formatting Utilities**
`frontend/src/lib/time-format.ts` - **NEW**

Comprehensive time formatting library:
- `formatCountdown(seconds, options)` - HH:MM:SS or MM:SS
- `formatHumanReadable(seconds)` - "2 hours 30 minutes"
- `formatCompact(seconds)` - "2h 30m"
- `formatTimestamp(unix, options)` - Locale date string
- `secondsToComponents(seconds)` - Parse to h/m/s/d
- `getTimeDiff(end, start)` - Calculate difference
- `isExpired(unix)` - Check if past
- `isInWindow(ts, start, end)` - Check if between timestamps

### 2. **Countdown Hook**
`frontend/src/hooks/useCountdown.ts` - **NEW**

Headless countdown logic for custom UIs:
```typescript
const { remaining, isExpired, isUrgent, hours, minutes, seconds } = useCountdown(endTs)
```

### 3. **Enhanced Solana Countdown Component**
`frontend/src/components/SolanaCountdown.tsx` - **ENHANCED**

Improved with configurable options:
```tsx
<SolanaCountdown 
  endTs={deadline}
  onExpire={() => {}}
  alwaysShowHours={true}
  showDays={false}
  urgentThreshold={60}
  urgentColor="text-red-600"
  className="custom-class"
/>
```

### 4. **Time Sync Hook**
`frontend/src/solana/time.ts` - **EXISTING (reviewed)**

Already excellent implementation:
- Auto-syncs every 15s with Solana RPC
- Calculates chain time offset
- Â±1 second accuracy guaranteed

### 5. **Documentation**
`docs/COUNTDOWN-GUIDE.md` - **NEW**

Complete developer guide with:
- API references
- Usage examples
- Best practices
- Troubleshooting
- Architecture decisions

## ğŸš€ Quick Start

### Basic Usage

```tsx
import { SolanaCountdown } from '@/components/SolanaCountdown'

function MyComponent() {
  return (
    <div>
      Time left: <SolanaCountdown endTs={1735689600} />
    </div>
  )
}
```

### With Formatting

```tsx
import { formatCountdown, formatHumanReadable } from '@/lib/time-format'

const remaining = 3661
console.log(formatCountdown(remaining))        // "01:01:01"
console.log(formatHumanReadable(remaining))    // "1 hour 1 minute"
```

### Custom Countdown

```tsx
import { useCountdown } from '@/hooks/useCountdown'

function CustomCountdown({ endTs }) {
  const { remaining, isUrgent, hours, minutes, seconds } = useCountdown(endTs)
  
  return (
    <div className={isUrgent ? 'text-red-600' : 'text-gray-900'}>
      {hours}:{minutes.toString().padStart(2, '0')}:{seconds.toString().padStart(2, '0')}
    </div>
  )
}
```

## ğŸ“Š API Cheat Sheet

### Components
| Component | Purpose | Syncs with Chain |
|-----------|---------|------------------|
| `<SolanaCountdown />` | Solana deadlines | âœ… Yes |
| `<Countdown />` | EVM/generic | âŒ No |

### Hooks
| Hook | Returns | Use Case |
|------|---------|----------|
| `useSolanaTime()` | `{ chainTime, offset, sync }` | Get chain timestamp |
| `useCountdown()` | `{ remaining, hours, minutes, seconds }` | Custom countdown UI |

### Format Functions
| Function | Example Output | Use Case |
|----------|----------------|----------|
| `formatCountdown(3661)` | `"01:01:01"` | Timer display |
| `formatHumanReadable(3661)` | `"1 hour 1 minute"` | Tooltip/message |
| `formatCompact(3661)` | `"1h 1m"` | Small UI space |
| `formatTimestamp(1735689600)` | `"Jan 1, 2025, 12:00 AM"` | Absolute time |

## âœ… Acceptance Criteria - ALL MET

### âœ… Accuracy Within Â±1 Second
- `useSolanaTime` syncs every 15s with RPC `getBlockTime()`
- Offset calculation: `chainTs - localTs`
- Display uses: `localTime + offset`
- No cumulative drift (periodic resync)

**Test:**
```typescript
const { chainTime, offset } = useSolanaTime()
const actual = await connection.getBlockTime(await connection.getSlot())
expect(Math.abs(chainTime - actual)).toBeLessThan(2)
```

### âœ… Modular & Reusable
**Three levels of abstraction:**

1. **High-level Component** (drop-in ready)
   ```tsx
   <SolanaCountdown endTs={deadline} />
   ```

2. **Headless Hook** (custom UI)
   ```tsx
   const countdown = useCountdown(deadline)
   ```

3. **Utility Functions** (full control)
   ```tsx
   formatCountdown(remaining)
   ```

**Used across screens:**
- âœ… JoinCommit - commit deadline
- âœ… RevealForm - reveal deadline
- âœ… ClaimPanel - settlement display
- âœ… Future screens can import same components

### âœ… Optional Formatting Helpers
**8+ formatting functions available:**
- âœ… `formatCountdown()` - HH:MM:SS
- âœ… `formatHumanReadable()` - Natural language
- âœ… `formatCompact()` - Short format
- âœ… `formatTimestamp()` - Locale strings
- âœ… `secondsToComponents()` - Parse
- âœ… `getTimeDiff()` - Calculate
- âœ… `isExpired()` - Check past
- âœ… `isInWindow()` - Check range

## ğŸ¨ Features Highlights

### 1. Flexible Display Options
```tsx
<SolanaCountdown endTs={deadline} alwaysShowHours />       // 00:05:30
<SolanaCountdown endTs={deadline} showDays />              // 1d 02:30:00
<SolanaCountdown endTs={deadline} urgentThreshold={300} /> // Urgent at 5min
```

### 2. Custom Styling
```tsx
<SolanaCountdown 
  endTs={deadline}
  className="text-3xl font-bold text-blue-600"
  urgentColor="text-orange-500"
/>
```

### 3. Lifecycle Callbacks
```tsx
<SolanaCountdown 
  endTs={deadline}
  onExpire={() => {
    setPhase('reveal')
    refetchRoundState()
  }}
/>
```

### 4. Time Zone Support
```tsx
formatTimestamp(deadline, {
  timeZone: 'America/New_York',
  dateStyle: 'full',
  timeStyle: 'short'
})
// "Monday, January 1, 2025 at 12:00 AM EST"
```

## ğŸ“ Architecture

### Time Sync Flow
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  useSolanaTime Hook                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Every 15s:                        â”‚  â”‚
â”‚  â”‚ 1. connection.getSlot()           â”‚  â”‚
â”‚  â”‚ 2. connection.getBlockTime(slot)  â”‚  â”‚
â”‚  â”‚ 3. offset = chainTs - localTs     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                          â”‚
â”‚  Provides: chainTime = now + offset     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SolanaCountdown Component              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Every 1s:                         â”‚  â”‚
â”‚  â”‚ 1. remaining = endTs - chainTime  â”‚  â”‚
â”‚  â”‚ 2. format display                 â”‚  â”‚
â”‚  â”‚ 3. check urgent/expired           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Component Hierarchy
```
SolanaCountdown
â”œâ”€â”€ useSolanaTime (chain sync)
â”œâ”€â”€ formatCountdown (display)
â””â”€â”€ useState/useEffect (tick logic)

useCountdown (headless)
â”œâ”€â”€ useState (remaining)
â””â”€â”€ useEffect (tick logic)

Format Utilities (pure functions)
â”œâ”€â”€ formatCountdown
â”œâ”€â”€ formatHumanReadable
â”œâ”€â”€ formatCompact
â””â”€â”€ etc.
```

## ğŸ”§ Configuration

### Sync Interval
```typescript
// Default: 15s (recommended)
useSolanaTime(15000)

// Aggressive: 5s (higher RPC cost)
useSolanaTime(5000)

// Relaxed: 30s (Â±2s drift possible)
useSolanaTime(30000)
```

### Urgent Threshold
```tsx
// Default: 60s
<SolanaCountdown endTs={deadline} />

// Custom: 5 minutes
<SolanaCountdown endTs={deadline} urgentThreshold={300} />
```

## ğŸ“ Scripts

```bash
# Start development
cd frontend
pnpm task:s1_9:start

# Mark done (already done)
pnpm task:s1_9:done

# Just dev
pnpm dev
```

## ğŸ§ª Testing

### Unit Test Example
```typescript
import { formatCountdown, secondsToComponents } from '@/lib/time-format'

describe('formatCountdown', () => {
  it('formats hours correctly', () => {
    expect(formatCountdown(3661)).toBe('01:01:01')
  })
  
  it('omits hours when zero', () => {
    expect(formatCountdown(125)).toBe('02:05')
  })
  
  it('shows hours when forced', () => {
    expect(formatCountdown(125, { alwaysShowHours: true })).toBe('00:02:05')
  })
})
```

### Integration Test
```typescript
import { render, screen } from '@testing-library/react'
import { SolanaCountdown } from '@/components/SolanaCountdown'

jest.mock('@/solana/time', () => ({
  useSolanaTime: () => ({ chainTime: 1000, offset: 0 })
}))

test('displays countdown', () => {
  render(<SolanaCountdown endTs={1125} />)
  expect(screen.getByText(/02:05/)).toBeInTheDocument()
})
```

## ğŸ“ Best Practices Summary

1. **Always use SolanaCountdown for Solana timestamps**
2. **Sync interval: 15s is optimal** (balance accuracy/cost)
3. **Handle expired states** with fallbacks
4. **Memoize expensive formatting** with useMemo
5. **Cleanup callbacks** with useCallback
6. **Provide accessibility** with aria-labels
7. **Mock time in tests** for deterministic results

## ğŸ“š Related Docs

- Full Guide: [`docs/COUNTDOWN-GUIDE.md`](./COUNTDOWN-GUIDE.md)
- S1.7 Reveal: [`docs/S1.7-IMPLEMENTATION.md`](./S1.7-IMPLEMENTATION.md)
- S1.8 Claim: [`docs/S1.8-IMPLEMENTATION.md`](./S1.8-IMPLEMENTATION.md)

## ğŸ† Status

**âœ… DONE** - Sprint S1.9 Complete

All acceptance criteria met:
- âœ… Â±1 second accuracy with chain sync
- âœ… Fully modular and reusable across screens
- âœ… Optional formatting helpers (8+ functions)
- âœ… Comprehensive documentation
- âœ… TypeScript types for all APIs

---

**Updated:** Oct 2025 | **Version:** 1.1 | **Sprint:** S1.9
