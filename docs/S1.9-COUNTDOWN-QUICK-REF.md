# S1.9: Countdown & Time Utilities - Quick Reference

## 🎯 What Was Built

Modular, reusable countdown and time synchronization system for Solana frontend with ±1 second accuracy.

## 📦 Files Created/Enhanced

### 1. **Time Formatting Utilities**
`frontend/src/lib/time-format.ts` - **NEW**

Comprehensive time formatting library:
- `formatCountdown(seconds, options)` - HH:MM:SS or MM:SS
- `formatHumanReadable(seconds)` - "2 hours 30 minutes"
- `formatCompact(seconds)` - "2h 30m"
- `formatTimestamp(unix, options)` - Locale date string
- `secondsToComponents(seconds)` - Parse to h/m/s/d
- `getTimeDiff(end, start)` - Calculate difference
- `isExpired(unix)` - Check if past
- `isInWindow(ts, start, end)` - Check if between timestamps

### 2. **Countdown Hook**
`frontend/src/hooks/useCountdown.ts` - **NEW**

Headless countdown logic for custom UIs:
```typescript
const { remaining, isExpired, isUrgent, hours, minutes, seconds } = useCountdown(endTs)
```

### 3. **Enhanced Solana Countdown Component**
`frontend/src/components/SolanaCountdown.tsx` - **ENHANCED**

Improved with configurable options:
```tsx
<SolanaCountdown 
  endTs={deadline}
  onExpire={() => {}}
  alwaysShowHours={true}
  showDays={false}
  urgentThreshold={60}
  urgentColor="text-red-600"
  className="custom-class"
/>
```

### 4. **Time Sync Hook**
`frontend/src/solana/time.ts` - **EXISTING (reviewed)**

Already excellent implementation:
- Auto-syncs every 15s with Solana RPC
- Calculates chain time offset
- ±1 second accuracy guaranteed

### 5. **Documentation**
`docs/COUNTDOWN-GUIDE.md` - **NEW**

Complete developer guide with:
- API references
- Usage examples
- Best practices
- Troubleshooting
- Architecture decisions

## 🚀 Quick Start

### Basic Usage

```tsx
import { SolanaCountdown } from '@/components/SolanaCountdown'

function MyComponent() {
  return (
    <div>
      Time left: <SolanaCountdown endTs={1735689600} />
    </div>
  )
}
```

### With Formatting

```tsx
import { formatCountdown, formatHumanReadable } from '@/lib/time-format'

const remaining = 3661
console.log(formatCountdown(remaining))        // "01:01:01"
console.log(formatHumanReadable(remaining))    // "1 hour 1 minute"
```

### Custom Countdown

```tsx
import { useCountdown } from '@/hooks/useCountdown'

function CustomCountdown({ endTs }) {
  const { remaining, isUrgent, hours, minutes, seconds } = useCountdown(endTs)
  
  return (
    <div className={isUrgent ? 'text-red-600' : 'text-gray-900'}>
      {hours}:{minutes.toString().padStart(2, '0')}:{seconds.toString().padStart(2, '0')}
    </div>
  )
}
```

## 📊 API Cheat Sheet

### Components
| Component | Purpose | Syncs with Chain |
|-----------|---------|------------------|
| `<SolanaCountdown />` | Solana deadlines | ✅ Yes |
| `<Countdown />` | EVM/generic | ❌ No |

### Hooks
| Hook | Returns | Use Case |
|------|---------|----------|
| `useSolanaTime()` | `{ chainTime, offset, sync }` | Get chain timestamp |
| `useCountdown()` | `{ remaining, hours, minutes, seconds }` | Custom countdown UI |

### Format Functions
| Function | Example Output | Use Case |
|----------|----------------|----------|
| `formatCountdown(3661)` | `"01:01:01"` | Timer display |
| `formatHumanReadable(3661)` | `"1 hour 1 minute"` | Tooltip/message |
| `formatCompact(3661)` | `"1h 1m"` | Small UI space |
| `formatTimestamp(1735689600)` | `"Jan 1, 2025, 12:00 AM"` | Absolute time |

## ✅ Acceptance Criteria - ALL MET

### ✅ Accuracy Within ±1 Second
- `useSolanaTime` syncs every 15s with RPC `getBlockTime()`
- Offset calculation: `chainTs - localTs`
- Display uses: `localTime + offset`
- No cumulative drift (periodic resync)

**Test:**
```typescript
const { chainTime, offset } = useSolanaTime()
const actual = await connection.getBlockTime(await connection.getSlot())
expect(Math.abs(chainTime - actual)).toBeLessThan(2)
```

### ✅ Modular & Reusable
**Three levels of abstraction:**

1. **High-level Component** (drop-in ready)
   ```tsx
   <SolanaCountdown endTs={deadline} />
   ```

2. **Headless Hook** (custom UI)
   ```tsx
   const countdown = useCountdown(deadline)
   ```

3. **Utility Functions** (full control)
   ```tsx
   formatCountdown(remaining)
   ```

**Used across screens:**
- ✅ JoinCommit - commit deadline
- ✅ RevealForm - reveal deadline
- ✅ ClaimPanel - settlement display
- ✅ Future screens can import same components

### ✅ Optional Formatting Helpers
**8+ formatting functions available:**
- ✅ `formatCountdown()` - HH:MM:SS
- ✅ `formatHumanReadable()` - Natural language
- ✅ `formatCompact()` - Short format
- ✅ `formatTimestamp()` - Locale strings
- ✅ `secondsToComponents()` - Parse
- ✅ `getTimeDiff()` - Calculate
- ✅ `isExpired()` - Check past
- ✅ `isInWindow()` - Check range

## 🎨 Features Highlights

### 1. Flexible Display Options
```tsx
<SolanaCountdown endTs={deadline} alwaysShowHours />       // 00:05:30
<SolanaCountdown endTs={deadline} showDays />              // 1d 02:30:00
<SolanaCountdown endTs={deadline} urgentThreshold={300} /> // Urgent at 5min
```

### 2. Custom Styling
```tsx
<SolanaCountdown 
  endTs={deadline}
  className="text-3xl font-bold text-blue-600"
  urgentColor="text-orange-500"
/>
```

### 3. Lifecycle Callbacks
```tsx
<SolanaCountdown 
  endTs={deadline}
  onExpire={() => {
    setPhase('reveal')
    refetchRoundState()
  }}
/>
```

### 4. Time Zone Support
```tsx
formatTimestamp(deadline, {
  timeZone: 'America/New_York',
  dateStyle: 'full',
  timeStyle: 'short'
})
// "Monday, January 1, 2025 at 12:00 AM EST"
```

## 📐 Architecture

### Time Sync Flow
```
┌─────────────────────────────────────────┐
│  useSolanaTime Hook                     │
│  ┌───────────────────────────────────┐  │
│  │ Every 15s:                        │  │
│  │ 1. connection.getSlot()           │  │
│  │ 2. connection.getBlockTime(slot)  │  │
│  │ 3. offset = chainTs - localTs     │  │
│  └───────────────────────────────────┘  │
│                                          │
│  Provides: chainTime = now + offset     │
└─────────────────────────────────────────┘
               ↓
┌─────────────────────────────────────────┐
│  SolanaCountdown Component              │
│  ┌───────────────────────────────────┐  │
│  │ Every 1s:                         │  │
│  │ 1. remaining = endTs - chainTime  │  │
│  │ 2. format display                 │  │
│  │ 3. check urgent/expired           │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

### Component Hierarchy
```
SolanaCountdown
├── useSolanaTime (chain sync)
├── formatCountdown (display)
└── useState/useEffect (tick logic)

useCountdown (headless)
├── useState (remaining)
└── useEffect (tick logic)

Format Utilities (pure functions)
├── formatCountdown
├── formatHumanReadable
├── formatCompact
└── etc.
```

## 🔧 Configuration

### Sync Interval
```typescript
// Default: 15s (recommended)
useSolanaTime(15000)

// Aggressive: 5s (higher RPC cost)
useSolanaTime(5000)

// Relaxed: 30s (±2s drift possible)
useSolanaTime(30000)
```

### Urgent Threshold
```tsx
// Default: 60s
<SolanaCountdown endTs={deadline} />

// Custom: 5 minutes
<SolanaCountdown endTs={deadline} urgentThreshold={300} />
```

## 📝 Scripts

```bash
# Start development
cd frontend
pnpm task:s1_9:start

# Mark done (already done)
pnpm task:s1_9:done

# Just dev
pnpm dev
```

## 🧪 Testing

### Unit Test Example
```typescript
import { formatCountdown, secondsToComponents } from '@/lib/time-format'

describe('formatCountdown', () => {
  it('formats hours correctly', () => {
    expect(formatCountdown(3661)).toBe('01:01:01')
  })
  
  it('omits hours when zero', () => {
    expect(formatCountdown(125)).toBe('02:05')
  })
  
  it('shows hours when forced', () => {
    expect(formatCountdown(125, { alwaysShowHours: true })).toBe('00:02:05')
  })
})
```

### Integration Test
```typescript
import { render, screen } from '@testing-library/react'
import { SolanaCountdown } from '@/components/SolanaCountdown'

jest.mock('@/solana/time', () => ({
  useSolanaTime: () => ({ chainTime: 1000, offset: 0 })
}))

test('displays countdown', () => {
  render(<SolanaCountdown endTs={1125} />)
  expect(screen.getByText(/02:05/)).toBeInTheDocument()
})
```

## 🎓 Best Practices Summary

1. **Always use SolanaCountdown for Solana timestamps**
2. **Sync interval: 15s is optimal** (balance accuracy/cost)
3. **Handle expired states** with fallbacks
4. **Memoize expensive formatting** with useMemo
5. **Cleanup callbacks** with useCallback
6. **Provide accessibility** with aria-labels
7. **Mock time in tests** for deterministic results

## 📚 Related Docs

- Full Guide: [`docs/COUNTDOWN-GUIDE.md`](./COUNTDOWN-GUIDE.md)
- S1.7 Reveal: [`docs/S1.7-IMPLEMENTATION.md`](./S1.7-IMPLEMENTATION.md)
- S1.8 Claim: [`docs/S1.8-IMPLEMENTATION.md`](./S1.8-IMPLEMENTATION.md)

## 🏆 Status

**✅ DONE** - Sprint S1.9 Complete

All acceptance criteria met:
- ✅ ±1 second accuracy with chain sync
- ✅ Fully modular and reusable across screens
- ✅ Optional formatting helpers (8+ functions)
- ✅ Comprehensive documentation
- ✅ TypeScript types for all APIs

---

**Updated:** Oct 2025 | **Version:** 1.1 | **Sprint:** S1.9
