---
id: S1.2
title: "Implement ChocoChoco Program v1 (Anchor, SOL native)"
epic: "E1 - Smart Contract Core"
sprint: "Sprint 1"
estimate: 8
labels: ["contract", "sprint-1"]
assignees: ["be1"]
dependencies: ["S1.1"]
status: "open"
---

## Solana migration (Program v1)

Context
- Triển khai logic commit-reveal bằng Anchor (Rust). Dùng `Clock` sysvar cho thời gian, lưu Round/PlayerRound bằng PDA.

Scope (Solana)
- Instructions: `commit_meow(commitment)`, `reveal_meow(tribe, salt)`, `settle_round()`, `claim_treat(round_id)`.
- Dữ liệu: PDA Round, PDA PlayerRound; lưu `commitment` và cờ `revealed/claimed` theo round/player.
- Hash: dùng `sha256(tribe || salt || player || round_id)` thống nhất với FE.

Acceptance Criteria
- `anchor build` pass, IDL có đủ instruction/events.
- Logic hoạt động theo spec: commit→reveal→settle→claim; tie refund; fee -> treasury.
- Event/logs cho: RoundCreated, MeowCommitted, MeowRevealed, RoundMeowed, TreatClaimed (qua Anchor events).

Tasks
- Khai báo accounts/state (Round/PlayerRound, Treasury, Config/Params cho round kế).
- Viết instructions commit/reveal/settle/claim theo CEI: cập nhật state trước khi chuyển lamports.
- Thêm events Anchor; cập nhật README contracts cách build/test.

## Context
Triển khai contract v1 (native token): commit–reveal, settle, claim, fee, tie refund, tắt forfeit.

## Scope
- constructor, commitMeow, revealMeow, settleRound, claimTreat, makeCommitment
- events & storage theo DESIGN.md

## Acceptance Criteria
- Compile pass
- Hàm hoạt động theo spec
- Events phát đúng dữ liệu

## Tasks
- Khai báo structs/enums/state
- Viết logic commit, reveal, settle, claim
- Thêm events

## Out of Scope
- ERC-20 mode, forfeit mode

## Notes
- Đã triển khai contract v1 native: commit–reveal, settle, claim, fee, tie refund, forfeit OFF (non-revealers refund).
- Đã thêm TDD với Foundry (`forge-std/Test.sol`) bao phủ happy/edge.
- Cần cài đặt Foundry và `forge install` dependencies để chạy test:
	- `forge install OpenZeppelin/openzeppelin-contracts --no-commit`
	- `forge install foundry-rs/forge-std --no-commit`
