---
id: S1.3
title: "Unit tests (Anchor): commit/reveal/settle/claim"
epic: "E1 - Smart Contract Core"
sprint: "Sprint 1"
estimate: 8
labels: ["contract", "tests", "sprint-1"]
assignees: ["be2"]
dependencies: ["S1.2"]
status: "open"
---

## Solana migration (Tests)

Context
- Viết tests bằng `@coral-xyz/anchor` (Mocha + TypeScript) hoặc Rust `solana-program-test` cho core logic.

Scope (Solana)
- commit stake sai/đúng, double-commit
- reveal sớm/trễ, bad salt/hash, double-reveal
- tie refund, fee accuracy (lamports)
- claim winner only, double-claim

Acceptance Criteria
- `anchor test` pass 100% cho các case trên.

Tasks
- Thiết lập provider, program, keypairs; helpers tạo salt/commitment sha256.
- Fixtures cho các đường đi: commit→reveal→settle→claim, bao gồm tie.

## Context
Viết test bao phủ happy/edge cho core logic.

## Scope
- commit stake sai/đúng, double-commit
- reveal sớm/trễ, bad salt/hash, double-reveal
- tie refund, fee accuracy
- claim winner only, double-claim

## Acceptance Criteria
- Tỷ lệ pass 100%
- Bao phủ tối thiểu các case nêu trên

## Kết quả kiểm thử (TDD)
- Đã thêm test Foundry trong `contracts/test/ChocoChocoGame.t.sol` bao phủ:
	- commit stake sai/đúng, commit sau deadline, double-commit
	- reveal sớm/trễ, bad salt/hash, double-reveal
	- settle trước hạn reveal (revert), settle mở round mới
	- tie: refund đầy đủ, không thu fee
	- fee accuracy: thu 1 lần khi có winner, payout = (totalPool-fee)/minorityPool
	- claim winner-only, pre-settle claim (revert), no-commit claim (revert), double-claim (revert)
- Tham chiếu: `src/ChocoChocoGame.sol` (đã có core logic v1: native token, forfeit OFF)

Kết quả: PASS 100% (20/20 test, bao gồm case gas/event cho settle). 

## Cách chạy test
```bash
cd contracts
forge test
```

Lưu ý: Cần Foundry (`foundryup`). Nếu môi trường có xung đột binary `forge`, chạy trên máy dev cục bộ hoặc Docker.

## Tasks
- Viết fixture vòng chơi
- Test commit/reveal/settle/claim
- Kiểm tra fee & payout
