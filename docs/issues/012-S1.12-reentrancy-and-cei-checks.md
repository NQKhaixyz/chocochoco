---
id: S1.12
title: "Reentrancy & CEI checks"
epic: "E5 - Security & QA"
sprint: "Sprint 1"
estimate: 3
labels: ["security", "contract", "sprint-1"]
assignees: ["be2"]
dependencies: ["S1.2"]
status: "open"
---

## Solana migration (Security ordering)

Context
- Reentrancy trên Solana khác EVM; tập trung vào thứ tự cập nhật state, kiểm tra seeds/PDA, và an toàn chuyển lamports/CPI.

Scope (Solana)
- Viết theo CEI: cập nhật flags (revealed/claimed/settled) trước khi chuyển lamports.
- Kiểm tra PDA seeds/owners; tránh CPI không cần thiết.

Acceptance Criteria
- Không có đường đi gây double-claim/double-reveal; chuyển lamports an toàn.

Tasks
- Rà soát code paths và thêm asserts Anchor constraints.

## Context
Đảm bảo claim và chuyển tiền tuân thủ ReentrancyGuard & CEI.

## Scope
- Thêm ReentrancyGuard
- Review effects-before-interactions

## Acceptance Criteria
- Không có lỗ hổng reentrancy rõ ràng
- Tests/linters (nếu có) pass

## Tasks
- Áp dụng nonReentrant cho claim
- Sắp xếp CEI

## Kết quả & kiểm thử
- Đã tích hợp `ReentrancyGuard` (OpenZeppelin) và gắn `nonReentrant` cho:
	- `claimTreat(uint256)`
	- `settleRound()` (bổ sung để tăng độ an toàn khi chuyển fee đến treasury)
- Đảm bảo CEI: cập nhật trạng thái (đánh dấu `claimed`) trước khi chuyển tiền, chuyển fee sau khi đánh dấu `Settled`.
- Test Foundry (file `contracts/test/ChocoChocoGame.t.sol`) pass 100% (20/20) sau thay đổi (bao gồm các bài test gas/event bổ sung từ S1.13).

## Cách chạy test
```bash
cd contracts
forge test
```

Ghi chú: V1 chỉ hỗ trợ claim/payout đến EOA (tài khoản thường). Claim đến contract có hành vi phức (callback) sẽ được xem xét ở phiên bản sau cùng với mô hình pull-payment/withdraw.
