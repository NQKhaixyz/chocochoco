---
id: S1.13
title: "Gas sanity & no large loops"
epic: "E5 - Security & QA"
sprint: "Sprint 1"
estimate: 2
labels: ["security", "gas", "sprint-1"]
assignees: ["be2"]
dependencies: ["S1.2", "S1.3"]
status: "done"
---

## Context
Đảm bảo không có vòng lặp payout; sự kiện tối thiểu.

## Scope
- Claim pull-only
- Event tối giản

## Acceptance Criteria
- Không có for-loop để trả thưởng
- Gas snapshot (nếu có) ổn định

## Tasks
- Review code paths
- Tối ưu event

## Kết quả & kiểm thử (TDD)
- Code path settle/claim không có for-loop payout. Payout theo pull (claim cá nhân).
- Sự kiện tối giản: settle phát đúng `RoundMeowed` cho round hiện tại và `RoundCreated` cho round kế tiếp.
- Thêm test Foundry trong `contracts/test/ChocoChocoGame.t.sol`:
	- `testSettleDoesNotPayoutDirectly`: xác nhận settle không chuyển tiền cho người chơi (pull-only).
	- `testSettleEmitsMinimalEvents`: đếm log, chỉ có 2 event (RoundMeowed, RoundCreated).
	- `testSettleGas_O1_withParticipants`: so sánh gas settle giữa case nhỏ (1v2) và lớn (10v40); chênh lệch nhỏ (< 50k) chứng minh O(1) theo số người chơi.
- Toàn bộ test (bao gồm bộ S1.3) PASS: 20/20.

## Cách chạy test
```bash
cd contracts
forge test
```

Ghi chú: Có thể bổ sung `forge snapshot` nếu cần ghi nhận snapshot gas chính thức trong CI.
