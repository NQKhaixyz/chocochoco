---
id: S2.1
title: "Forfeit mode (partial/full)"
epic: "E1 - Contract v2 features"
sprint: "Sprint 2"
estimate: 8
labels: ["contract", "security", "sprint-2"]
assignees: ["be1"]
dependencies: ["S1.2", "S1.3"]
status: "open"
---

## Solana migration (Forfeit)

Context
- Áp dụng forfeit khi no-reveal: partial (bps) hoặc full, gửi về treasury.

Scope (Solana)
- Params trong state (forfeit_mode, forfeit_bps) và áp dụng tại claim.

Acceptance Criteria
- Case no-reveal bị phạt đúng; tests bao phủ partial/full.

Tasks
- Implement forfeit trong Anchor; cập nhật unit tests.

## Context
Thêm forfeit khi no-reveal: partial (bps) hoặc full.

## Scope
- Tham số forfeitMode, forfeitBps
- Áp dụng vào settle/claim theo DESIGN.md

## Acceptance Criteria
- Case no-reveal bị phạt đúng
- Tests bao phủ partial/full

## Tasks
- Implement forfeit
- Unit tests no-reveal

## Result
- Implemented forfeit mode in `ChocoChocoGame.sol` with defaults per-round:
	- Modes: None (0), Partial (1, with `forfeitBps`), Full (2)
	- Applied at claim time for non-revealers (both tie and non-tie cases). Penalty sent to `treasury`.
	- Winner payout remains based on revealed pools only; fee transferred on settle only when there is a winner.
- Added/updated Foundry tests in `contracts/test/ChocoChocoGame.t.sol`:
	- `testNonRevealRefund_ForfeitOff` (baseline none)
	- `testForfeit_Partial_NoReveal_Tie` (partial penalty on tie)
	- `testForfeit_Full_NoReveal_Tie` (full penalty on tie)
	- `testForfeit_Partial_WinnerPayoutUnchanged_DistributedToTreasury` (partial penalty with a winner; fee only on revealed pool; winner payout unaffected)

## Verification
- All tests pass: 23/23.
- Acceptance criteria satisfied:
	- No-reveal cases are penalized exactly per mode (partial/full) and routed to treasury.
	- Partial and full scenarios covered by unit tests.
