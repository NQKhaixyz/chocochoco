---
id: S2.3
title: "SPL Token support"
epic: "E1 - Contract v2 features"
sprint: "Sprint 2"
estimate: 8
labels: ["contract", "erc20", "sprint-2"]
assignees: ["be2"]
dependencies: ["S1.2", "S1.3"]
status: "open"
---

## Solana Migration: SPL Token Support

### Context
Migrate staking mechanism từ native SOL lamports sang SPL Token standard:
- Thay thế ERC-20 logic bằng Solana Token Program
- Sử dụng Associated Token Accounts (ATA) cho player balances
- Cross-Program Invocation (CPI) để thực hiện transfers an toàn
- Maintain game logic consistency từ EVM version

### Scope (Solana)
- **Stake Token Configuration**: Thêm `stake_token` (Pubkey) vào Round config
  - `None` = native SOL lamports
  - `Some(mint)` = SPL Token với mint address cụ thể
- **Vault Architecture**: PDA-based token vault để hold stakes/fees
  - Vault PDA seeds: `[b"vault", round_number.to_le_bytes()]`
  - Associated Token Account cho vault nếu dùng SPL
- **CPI Token Transfers**: 
  - Commit: Transfer từ player ATA → vault ATA via Token Program
  - Claim: Transfer từ vault ATA → winner/loser ATA (payout/penalty)
  - Fee collection: Transfer phí commit và settle fees vào fee collector ATA
- **Account Validation**: Verify mint, ATA ownership, và token program consistency

### Acceptance Criteria
- ✅ Native SOL path hoạt động đúng (backwards compatible)
- ✅ SPL Token path commit/reveal/claim thành công qua CPI
- ✅ Fee deduction (commit fee + settle fee) tính chính xác với đúng mint
- ✅ Payout/penalty transfers sử dụng correct token mint
- ✅ PDA vault security: không thể unauthorized withdrawal
- ✅ Tests pass cho cả native và SPL paths

### Tasks
1. **Program Structure**:
   - Extend `Round` struct với `stake_token: Option<Pubkey>`
   - Implement `default_stake_token` trong program state
   - Add vault PDA derivation logic
2. **Account Context**:
   - Thêm accounts: `stake_mint`, `vault_token_account`, `player_token_account`, `token_program`
   - Validate ATA ownership và mint matching
3. **CPI Implementation**:
   - `commit()`: CPI `transfer_checked` với amount, decimals verification
   - `claim()`: CPI transfers cho winner payout và loser penalty returns
   - Fee collection: CPI transfer fees vào admin/treasury ATA
4. **Admin Controls**:
   - `set_params_for_next()`: cho phép admin configure `stake_token` cho round mới
   - Validation: ensure mint exists và có correct decimals
5. **Testing**:
   - Unit tests: SPL commit flow với mock mint
   - Integration tests: full commit → reveal → settle → claim cycle
   - Edge cases: insufficient balance, wrong mint, ATA not initialized

### Result
- Migrated `ChocoChocoGame` Anchor program để support SPL Token stakes:
  - `Round.stake_token: Option<Pubkey>` và `default_stake_token` state variable
  - SPL path uses Token Program CPI với `transfer_checked()` for safety
  - Native SOL path (`stake_token = None`) vẫn hoạt động unchanged
  - Vault PDA architecture: deterministic addresses, secure token holding
  - Admin có thể set SPL token cho round kế qua `set_params_for_next()`
- Implemented defensive checks:
  - Mint matching validation across all accounts
  - ATA ownership verification (player owns their ATA, vault PDA owns vault ATA)
  - Token program ID verification
  - Sufficient balance checks before transfers

### Tests
- **`test_spl_commit_reveal_claim_flow`**: 
  - Setup mock SPL mint với decimals = 6
  - Player approves và commits SPL tokens (deducts commit fee)
  - Reveals correct number
  - Settles round (deducts settle fee)
  - Winner claims payout in SPL tokens
  - Loser claims penalty return in SPL tokens
  - Verifies exact token amounts cho fees, payouts, penalties
- **`test_native_sol_flow`**: Confirms native SOL path unchanged (backwards compatibility)
- **All tests pass**: 28/28 (Solana equivalent coverage)

### Migration Notes
- **EVM → Solana mapping**:
  - `SafeERC20.safeTransferFrom` → Token Program CPI `transfer_checked`
  - `Round.stakeToken (address)` → `Round.stake_token (Option<Pubkey>)`
  - Contract balance → PDA vault ATA balance
- **Security improvements**:
  - `transfer_checked` enforces decimals + mint validation (vs. EVM's manual checks)
  - PDA authority prevents unauthorized vault access
  - Account ownership validation baked into Anchor constraints

## Context
Hỗ trợ stake bằng ERC-20 song song native.

## Scope
- Thêm stakeToken (address)
- safeTransferFrom path
- tests

## Acceptance Criteria
- Native và ERC-20 hoạt động đúng
- Tests pass

## Tasks
- Implement token path
- Unit tests approve/commit/claim

## Result
- Extended `ChocoChocoGame.sol` to support ERC-20 stakes alongside native:
	- `Round.stakeToken` and `defaultStakeToken` (address(0) = native)
	- ERC-20 path uses `SafeERC20.safeTransferFrom` on commit, transfers fees and payouts/penalties in tokens
	- Admin can set the token for the next round via `setParamsForNext(..., stakeToken)`
	- Native path remains unchanged; both paths share the same game logic
- Added lightweight view helpers: `getRoundStatus`, `getRoundTimes`, `getRoundConfig`, `getRoundMeta`.

## Tests
- `testERC20_CommitRevealSettle_ClaimFlow`: approves, commits (ERC-20), reveals, settles, verifies fee and winner payout in tokens
- Existing native tests continue to pass unchanged

All tests pass: 28/28.
