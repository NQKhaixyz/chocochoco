---
id: S2.3
title: "ERC-20 support (SafeERC20)"
epic: "E1 - Contract v2 features"
sprint: "Sprint 2"
estimate: 8
labels: ["contract", "erc20", "sprint-2"]
assignees: ["be2"]
dependencies: ["S1.2", "S1.3"]
status: "done"
---

## Context
Hỗ trợ stake bằng ERC-20 song song native.

## Scope
- Thêm stakeToken (address)
- safeTransferFrom path
- tests

## Acceptance Criteria
- Native và ERC-20 hoạt động đúng
- Tests pass

## Tasks
- Implement token path
- Unit tests approve/commit/claim

## Result
- Extended `ChocoChocoGame.sol` to support ERC-20 stakes alongside native:
	- `Round.stakeToken` and `defaultStakeToken` (address(0) = native)
	- ERC-20 path uses `SafeERC20.safeTransferFrom` on commit, transfers fees and payouts/penalties in tokens
	- Admin can set the token for the next round via `setParamsForNext(..., stakeToken)`
	- Native path remains unchanged; both paths share the same game logic
- Added lightweight view helpers: `getRoundStatus`, `getRoundTimes`, `getRoundConfig`, `getRoundMeta`.

## Tests
- `testERC20_CommitRevealSettle_ClaimFlow`: approves, commits (ERC-20), reveals, settles, verifies fee and winner payout in tokens
- Existing native tests continue to pass unchanged

All tests pass: 28/28.
