---
id: S2.3
title: "SPL Token support"
epic: "E1 - Contract v2 features"
sprint: "Sprint 2"
estimate: 8
labels: ["contract", "erc20", "sprint-2"]
assignees: ["be2"]
dependencies: ["S1.2", "S1.3"]
status: "open"
---

## Solana migration (SPL Token)

Context
- Hỗ trợ tài sản SPL thay vì ERC-20; sử dụng Token Program + ATA.

Scope (Solana)
- Commit/reveal/claim sử dụng cùng loại tài sản SPL; chuyển bằng CPI đến Token Program.

Acceptance Criteria
- Tests pass cho đường đi SPL (approve/transfer via ATA), fee/penalty/payout dùng đúng mint.

Tasks
- Thêm accounts cho mint, vault (PDA), và ATA người chơi; viết CPI calls an toàn.

## Context
Hỗ trợ stake bằng ERC-20 song song native.

## Scope
- Thêm stakeToken (address)
- safeTransferFrom path
- tests

## Acceptance Criteria
- Native và ERC-20 hoạt động đúng
- Tests pass

## Tasks
- Implement token path
- Unit tests approve/commit/claim

## Result
- Extended `ChocoChocoGame.sol` to support ERC-20 stakes alongside native:
	- `Round.stakeToken` and `defaultStakeToken` (address(0) = native)
	- ERC-20 path uses `SafeERC20.safeTransferFrom` on commit, transfers fees and payouts/penalties in tokens
	- Admin can set the token for the next round via `setParamsForNext(..., stakeToken)`
	- Native path remains unchanged; both paths share the same game logic
- Added lightweight view helpers: `getRoundStatus`, `getRoundTimes`, `getRoundConfig`, `getRoundMeta`.

## Tests
- `testERC20_CommitRevealSettle_ClaimFlow`: approves, commits (ERC-20), reveals, settles, verifies fee and winner payout in tokens
- Existing native tests continue to pass unchanged

All tests pass: 28/28.
