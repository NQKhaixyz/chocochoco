---
id: S2.8
title: "Property/Fuzz & Invariants"
epic: "E5 - Security & QA"
sprint: "Sprint 2"
estimate: 8
labels: ["security", "tests", "sprint-2"]
assignees: ["be2"]
dependencies: ["S1.3", "S2.1", "S2.3"]
status: "open"
---

## Solana migration (Invariants)

Context
- Chuyển tests fuzz/invariant sang Rust (`solana-program-test` + `proptest`) hoặc mở rộng TS tests với nhiều cases.

Scope (Solana)
- Invariant: tổng winners' claims mỗi round không vượt quá distributable (sau fee), không tính tie refund/penalty.

Acceptance Criteria
- Suites invariant pass (N lần chạy) cho native SOL và SPL Token mode.

Tasks
- Thêm helpers đọc state pools/meta; viết invariant tests và tài liệu chạy.

## Context
Bảo toàn tiền, không overflow, tổng claim <= distributable.

## Scope
- Property-based tests
- Fuzz & invariant

## Acceptance Criteria
- Các thuộc tính an toàn giữ vững qua fuzz

## Tasks
- Viết property/invariant tests
- Tích hợp vào CI 

## Result
- Added property-based and invariant tests with Foundry:
	- Invariants in `contracts/test/InvariantChocoChoco.t.sol` using `StdInvariant`:
		- Native and ERC-20 suites with handlers that fuzz actions (commit/reveal/warp/settle/claim)
		- Invariant: total winners' claims per settled round never exceed distributable (total revealed pool minus fee)
	- Lightweight view helpers added to `ChocoChocoGame.sol` for invariant computations:
		- `getRoundStatus`, `getRoundTimes`, `getRoundConfig`, `getRoundPools`, `getRoundMeta`
- All tests pass locally: 30/30, including both invariant suites (256 runs each).

## Notes
- The invariant focuses on conservation for the winners' pool (excludes tie refunds and non-revealer refunds by design). Penalties are routed to treasury and do not affect the distributable bound.
- Suites cover both native-asset and ERC-20 modes to ensure consistency across asset types.
