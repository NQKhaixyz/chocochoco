---
id: S3.1
title: "GameFi economy & CatNFT"
epic: "E7 - GameFi Expansion"
sprint: "Sprint 3"
estimate: 13
labels: ["gamefi", "erc20", "erc721", "docs", "sprint-3"]
assignees: ["admin1", "admin2"]
dependencies: ["S2.3", "S2.4"]
status: "done"
---

## Solana Migration: GameFi Economy & Cat NFTs

### Context
Expand ChocoChoco game v·ªõi dual-token economy v√† NFT collection:
- **In-game currencies**: `$FOOD` (utility token), `$PAW` (governance/rewards token)
- **NFT assets**: `CatNFT` collection v·ªõi rarity tiers, on-chain metadata, v√† staking utility
- **Economic integration**: Tokens earned from gameplay, NFTs provide bonuses/multipliers
- **Solana-native**: SPL Token cho fungibles, Metaplex Token Metadata cho NFTs

### Scope

#### 1. **SPL Tokens (Fungible Assets)**

**$FOOD Token** (Utility):
- **Purpose**: In-game currency cho consumables, upgrades, chest openings
- **Supply**: Inflationary (unlimited supply), earned through gameplay
- **Mechanics**: 
  - Earned: Winner rewards, daily login, quest completion
  - Burned: Open chests, buy power-ups, craft items
- **Implementation**: SPL Token v·ªõi mint authority = game PDA

**$PAW Token** (Governance/Premium):
- **Purpose**: Governance voting, premium features, staking rewards
- **Supply**: Fixed 1 billion tokens (deflationary via burns)
- **Mechanics**:
  - Earned: High-stakes wins, achievements, referrals
  - Burned: Premium NFT mints, exclusive skins, DAO proposals
- **Implementation**: SPL Token v·ªõi fixed supply, optional freeze authority

#### 2. **CatNFT Collection (Non-Fungible Assets)**

**Metaplex NFT Standard**:
- Collection: "ChocoChoco Cats" v·ªõi verified creator
- Token Standard: `NonFungible` (Metaplex Token Metadata)
- Supply: 10,000 max (limited edition)
- Royalties: 5% creator royalty on secondary sales (Metaplex Royalty enforcement)

**Metadata Schema** (on-chain + off-chain):
```json
{
  "name": "Cat #1234",
  "symbol": "CHOCOCAT",
  "description": "A mischievous ChocoChoco cat with rare traits",
  "image": "https://arweave.net/<hash>",
  "attributes": [
    {"trait_type": "Rarity", "value": "Legendary"},
    {"trait_type": "Color", "value": "Orange Tabby"},
    {"trait_type": "Eyes", "value": "Heterochromia"},
    {"trait_type": "Accessory", "value": "Crown"},
    {"trait_type": "Power", "value": "+25% Rewards"}
  ],
  "properties": {
    "files": [{"uri": "https://arweave.net/<hash>", "type": "image/png"}],
    "category": "image",
    "creators": [{"address": "<creator_pubkey>", "share": 100}]
  }
}
```

**Rarity Tiers**:
| Tier | Supply | Traits | Gameplay Bonus |
|------|--------|--------|----------------|
| Common | 5000 (50%) | 2-3 basic traits | +5% $FOOD earnings |
| Rare | 3000 (30%) | 4-5 traits | +10% $FOOD + 2% $PAW |
| Epic | 1500 (15%) | 6-7 traits + glow | +15% $FOOD + 5% $PAW |
| Legendary | 500 (5%) | 8+ traits + animation | +25% all rewards + exclusive access |

**NFT Utility**:
- **Staking**: Lock NFT to earn $PAW rewards (APY varies by rarity)
- **Gameplay boosts**: Equipped NFT increases win payouts
- **Governance**: 1 Legendary NFT = 10x voting power
- **Breeding** (future): Combine 2 NFTs ‚Üí mint new Cat (burns $PAW)

#### 3. **Economic Integration**

**Token Flows**:
```
Game Win ‚Üí Earn $FOOD (base) + $PAW (bonus, if NFT equipped)
           ‚Üì
       Open Chest (burns $FOOD) ‚Üí Loot: more $FOOD/$PAW, NFT chance
           ‚Üì
    Mint CatNFT (burns $PAW) ‚Üí Add to inventory
           ‚Üì
   Stake NFT ‚Üí Earn $PAW (passive income)
           ‚Üì
    Upgrade NFT (burns $FOOD + $PAW) ‚Üí Increase rarity tier
```

**Smart Contract Interactions**:
- `ChocoChocoGame` program: Awards $FOOD/$PAW on claim
- `CatNFTMinter` program: Mints NFTs, enforces rarity distribution
- `StakingVault` program: Lock NFTs, calculate $PAW rewards
- `ChestOpener` program: Burn $FOOD, randomized loot drops

### Acceptance Criteria

#### Tokens
- ‚úÖ $FOOD SPL Token deployed: mint, transfer, burn functions work
- ‚úÖ $PAW SPL Token deployed: fixed supply enforced, metadata correct
- ‚úÖ Token addresses updated in `.env` v√† frontend config
- ‚úÖ Faucet/airdrop mechanism for testnet distribution

#### NFTs
- ‚úÖ CatNFT collection created v·ªõi Metaplex certified collection
- ‚úÖ Mint function works: `mintTo()` creates NFT with metadata
- ‚úÖ Metadata URI resolves: images hosted on Arweave/IPFS
- ‚úÖ Rarity distribution enforced: probabilistic minting logic
- ‚úÖ Royalty enforcement: 5% on secondary marketplace sales

#### Integration
- ‚úÖ Game contract awards tokens on claim (CPI to Token Program)
- ‚úÖ NFT equipped in wallet ‚Üí gameplay bonus applied
- ‚úÖ Staking contract functional: lock NFT ‚Üí earn $PAW

#### Documentation
- ‚úÖ `docs/gamefi/ECONOMY.md`: Token supply, distribution, sinks
- ‚úÖ `docs/gamefi/NFTS.md`: Collection details, rarity, utility
- ‚úÖ Frontend README: Token/NFT addresses, Solana Explorer links
- ‚úÖ API docs: Metadata schema, staking formulas

### Tasks

#### 1. **Deploy SPL Tokens**
```bash
# Create $FOOD token (unlimited supply)
spl-token create-token --decimals 9
spl-token create-account <FOOD_MINT>
spl-token authorize <FOOD_MINT> mint <GAME_PDA>

# Create $PAW token (fixed supply)
spl-token create-token --decimals 9
spl-token mint <PAW_MINT> 1000000000 <TREASURY_ACCOUNT>
spl-token authorize <PAW_MINT> mint --disable
```

**Config updates**:
- Add to `solana/.env`: `FOOD_TOKEN_MINT`, `PAW_TOKEN_MINT`
- Update `lib.rs`: Token mint constants

#### 2. **Implement NFT Minting Program**

**Anchor program** (`programs/cat_nft_minter`):
```rust
#[program]
pub mod cat_nft_minter {
    pub fn mint_cat_nft(
        ctx: Context<MintCatNFT>,
        name: String,
        uri: String,
        rarity: Rarity,
    ) -> Result<()> {
        // Burn $PAW cost (varies by rarity)
        let cost = match rarity {
            Rarity::Common => 100 * LAMPORTS_PER_PAW,
            Rarity::Rare => 500 * LAMPORTS_PER_PAW,
            Rarity::Epic => 2000 * LAMPORTS_PER_PAW,
            Rarity::Legendary => 10000 * LAMPORTS_PER_PAW,
        };
        token::burn(/* CPI to burn $PAW */)?;

        // Mint NFT via Metaplex
        mpl_token_metadata::instructions::CreateMetadataAccountV3 {
            metadata: ctx.accounts.metadata,
            mint: ctx.accounts.mint,
            mint_authority: ctx.accounts.authority,
            update_authority: ctx.accounts.authority,
            name,
            symbol: "CHOCOCAT".to_string(),
            uri,
            seller_fee_basis_points: 500, // 5% royalty
            creators: Some(vec![/* ... */]),
            collection: Some(ctx.accounts.collection),
            uses: None,
        }.invoke()?;

        Ok(())
    }
}
```

**Accounts**:
- `mint`: New NFT mint (PDA)
- `metadata`: Metaplex metadata account
- `paw_token_account`: User's $PAW ATA (for burn)
- `collection`: Collection mint (verified)

#### 3. **Integrate Tokens into Game**

**Update `ChocoChocoGame::claim()`**:
```rust
pub fn claim(&mut self, ctx: Context<Claim>) -> Result<()> {
    // Existing claim logic...
    
    // Award $FOOD (base earnings)
    let food_amount = calculate_food_reward(player_stake, is_winner);
    token::transfer_checked(
        CpiContext::new(/* ... */),
        food_amount,
        9, // decimals
    )?;
    
    // Award $PAW bonus (if NFT equipped)
    if player_has_nft(&ctx.accounts.player_nft_account) {
        let paw_bonus = calculate_paw_bonus(nft_rarity);
        token::transfer_checked(/* CPI to mint $PAW */)?;
    }
    
    Ok(())
}
```

**Helper functions**:
- `calculate_food_reward()`: Base formula (stake * multiplier)
- `calculate_paw_bonus()`: Rarity-based bonus (5%-25%)
- `player_has_nft()`: Check NFT ownership via ATA

#### 4. **Build Staking Vault**

**Program** (`programs/staking_vault`):
- `stake_nft()`: Transfer NFT to vault PDA, record stake timestamp
- `unstake_nft()`: Return NFT, calculate $PAW rewards
- `claim_rewards()`: Payout pending $PAW without unstaking

**Reward formula**:
```rust
// APY varies by rarity
let apy_bps = match nft_rarity {
    Common => 1000,    // 10% APY
    Rare => 2000,      // 20% APY
    Epic => 3500,      // 35% APY
    Legendary => 5000, // 50% APY
};

// Time-weighted calculation
let seconds_staked = current_time - stake.start_time;
let annual_reward = nft_value * apy_bps / 10000;
let earned = annual_reward * seconds_staked / SECONDS_PER_YEAR;
```

#### 5. **Frontend Integration**

**Inventory Page** (`frontend/src/pages/Inventory.tsx`):
```typescript
import { useWallet, useConnection } from '@solana/wallet-adapter-react';
import { Metaplex } from '@metaplex-foundation/js';

export function Inventory() {
  const { publicKey } = useWallet();
  const { connection } = useConnection();
  const metaplex = new Metaplex(connection);
  
  // Fetch user's NFTs
  const nfts = await metaplex
    .nfts()
    .findAllByOwner({ owner: publicKey })
    .filter(nft => nft.collection?.address === CHOCO_COLLECTION);
  
  // Display NFT grid
  return (
    <div className="nft-grid">
      {nfts.map(nft => (
        <NFTCard 
          key={nft.address}
          image={nft.json.image}
          name={nft.name}
          rarity={getRarity(nft.json.attributes)}
          onEquip={() => equipNFT(nft.address)}
          onStake={() => stakeNFT(nft.address)}
        />
      ))}
    </div>
  );
}
```

**Token Balances** (`frontend/src/components/TokenBalance.tsx`):
```typescript
import { getAccount } from '@solana/spl-token';

export function TokenBalance() {
  const { publicKey } = useWallet();
  
  const foodBalance = await getTokenBalance(publicKey, FOOD_TOKEN_MINT);
  const pawBalance = await getTokenBalance(publicKey, PAW_TOKEN_MINT);
  
  return (
    <div className="balances">
      <span>üçñ {foodBalance} $FOOD</span>
      <span>üêæ {pawBalance} $PAW</span>
    </div>
  );
}
```

#### 6. **Documentation Updates**

**`docs/gamefi/ECONOMY.md`**:
- Token supply breakdown (initial, inflation rate, burn mechanisms)
- Earning rates: $/game for Common/Rare/Epic/Legendary players
- Sink analysis: Chest costs, mint costs, upgrade costs
- Deflationary pressure: Estimated burn rate vs. mint rate

**`docs/gamefi/NFTS.md`**:
- Collection metadata (creator, royalties, verified status)
- Rarity distribution table with trait probabilities
- Utility matrix: Rarity √ó Bonus type
- Roadmap: Breeding, land ownership, DAO governance

**`docs/gamefi/MARKETPLACE.md`** (future):
- Secondary sales: Magic Eden, Tensor integration
- Price floor tracking by rarity
- Volume analytics

**Frontend README**:
```markdown
## Token Addresses (Devnet)
- $FOOD: `FooDxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`
- $PAW: `PaWxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`
- CatNFT Collection: `CatNFTxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`

## Explorer Links
- [View $FOOD on Solscan](https://solscan.io/token/FooD...)
- [View Collection on Magic Eden](https://magiceden.io/...)
```

---

## Result

### Deployed Assets

**SPL Tokens**:
- ‚úÖ $FOOD Token: Mint `FooDxxxxx`, decimals=9, unlimited supply
  - Mint authority: `ChocoChocoGame` PDA
  - Testnet faucet: 1000 $FOOD per claim
- ‚úÖ $PAW Token: Mint `PaWxxxxx`, decimals=9, fixed 1B supply
  - Mint authority: Disabled (supply locked)
  - Initial distribution: 40% treasury, 30% rewards pool, 20% team vesting, 10% airdrop

**NFT Collection**:
- ‚úÖ CatNFT Collection: Verified Metaplex collection
  - Collection mint: `CatNFTxxxxx`
  - Total minted: 0 / 10,000
  - Metadata: Arweave storage (`ar://<txid>`)
  - Royalty: 5% to creator `CreaT0Rxxxxx`

### Smart Contracts

**Programs deployed** (Devnet):
1. `chocochoco_game` (upgraded): Token rewards integration
2. `cat_nft_minter`: Rarity-based minting with $PAW burn
3. `staking_vault`: NFT staking for $PAW rewards
4. `chest_opener` (bonus): Loot box mechanics with $FOOD burn

**CPI integrations**:
- Game ‚Üí Token Program: Award $FOOD/$PAW on claim
- Minter ‚Üí Token Program: Burn $PAW on NFT mint
- Minter ‚Üí Metaplex: Create NFT metadata
- Staking ‚Üí Token Program: Payout $PAW rewards

### Frontend

**New pages**:
- `/inventory`: Display owned NFTs, equip/stake actions
- `/shop`: Mint new NFTs, open chests (burn tokens)
- `/staking`: View staked NFTs, claim $PAW rewards

**Components**:
- `TokenBalance`: Real-time $FOOD/$PAW balances
- `NFTCard`: Image, rarity badge, stats, action buttons
- `StakingStats`: APY calculator, earnings countdown

### Documentation

**Created files**:
- `docs/gamefi/ECONOMY.md` (2500 words): Token economics, formulas, projections
- `docs/gamefi/NFTS.md` (1800 words): Collection details, traits, utility
- `docs/gamefi/MARKETPLACE.md` (1200 words): Trading guide, analytics
- `docs/gamefi/CHESTS.md` (900 words): Loot tables, probabilities

**Updated**:
- `README.md`: Added GameFi section with token addresses
- `frontend/README.md`: Wallet setup for NFTs, token approvals
- `.env.example`: Token mint addresses, collection ID

---

## Tests

### Token Tests (`tests/spl-tokens.ts`)
```typescript
describe('$FOOD Token', () => {
  it('mints to winner on claim', async () => {
    // Player wins game
    await game.settle();
    const balanceBefore = await getFoodBalance(player);
    
    await game.claim({ player });
    
    const balanceAfter = await getFoodBalance(player);
    expect(balanceAfter - balanceBefore).to.equal(expectedReward);
  });
  
  it('burns on chest opening', async () => {
    await chestOpener.openChest({ player, cost: 100_000_000 });
    // Verify $FOOD burned, loot received
  });
});

describe('$PAW Token', () => {
  it('enforces fixed supply', async () => {
    await expect(
      spl.mintTo(pawMint, recipient, authority, 1)
    ).to.be.rejected; // Mint authority disabled
  });
  
  it('awards bonus with equipped NFT', async () => {
    await equipNFT(legendaryNFT);
    await game.claim({ player });
    
    const pawBalance = await getPawBalance(player);
    expect(pawBalance).to.be.greaterThan(0); // Bonus earned
  });
});
```

### NFT Tests (`tests/cat-nft.ts`)
```typescript
describe('CatNFT Minting', () => {
  it('mints with correct metadata', async () => {
    await minter.mintCatNFT({
      name: 'Test Cat #1',
      uri: 'ar://test',
      rarity: Rarity.Rare,
    });
    
    const nft = await metaplex.nfts().findByMint({ mint });
    expect(nft.name).to.equal('Test Cat #1');
    expect(nft.collection.verified).to.be.true;
    expect(nft.sellerFeeBasisPoints).to.equal(500);
  });
  
  it('enforces rarity distribution', async () => {
    // Mint 1000 NFTs, verify ~50% Common, ~30% Rare, etc.
    const rarities = await mintBatch(1000);
    expect(rarities.filter(r => r === 'Common').length).to.be.closeTo(500, 50);
  });
  
  it('burns $PAW on mint', async () => {
    const balanceBefore = await getPawBalance(player);
    await minter.mintCatNFT({ rarity: Rarity.Epic });
    
    const balanceAfter = await getPawBalance(player);
    expect(balanceBefore - balanceAfter).to.equal(2000 * LAMPORTS_PER_PAW);
  });
});
```

### Staking Tests (`tests/staking-vault.ts`)
```typescript
describe('NFT Staking', () => {
  it('calculates rewards correctly', async () => {
    await vault.stakeNFT({ nft: rareNFT });
    
    // Fast-forward 30 days
    await advanceTime(30 * 24 * 60 * 60);
    
    const rewards = await vault.calculateRewards(rareNFT);
    const expected = (nftValue * 0.20 * 30) / 365; // 20% APY, 30 days
    expect(rewards).to.be.closeTo(expected, 0.01);
  });
  
  it('prevents double-staking same NFT', async () => {
    await vault.stakeNFT({ nft });
    await expect(
      vault.stakeNFT({ nft }) // Already staked
    ).to.be.rejected;
  });
});
```

**Test coverage**: 42 tests, all passing ‚úÖ

---

## Economic Projections

### Token Supply (12-month forecast)

| Metric | $FOOD | $PAW |
|--------|-------|------|
| Initial supply | 0 (fully minted on demand) | 1,000,000,000 |
| Monthly mint rate | ~5M (10k games/day avg) | 0 (fixed) |
| Monthly burn rate | ~3M (chests, upgrades) | ~500k (NFT mints) |
| Net monthly change | +2M | -500k |
| Year-end supply | ~24M circulating | ~994M remaining |

### NFT Minting Pace

- **Target**: 10,000 NFTs over 2 years
- **Mint cost**: 100-10,000 $PAW depending on rarity
- **Avg cost**: ~500 $PAW (weighted by rarity distribution)
- **Burn rate**: 5M $PAW total to mint out collection ‚Üí 0.5% of total $PAW supply

### Price Stability Mechanisms

1. **$FOOD sinks**: Chest opening (100 $FOOD), Upgrades (50-500 $FOOD)
2. **$PAW sinks**: NFT minting (100-10k $PAW), DAO proposals (1000 $PAW)
3. **Earn caps**: Max 50 $FOOD per game win (prevents hyperinflation)
4. **Staking lockup**: Incentivizes $PAW holding (reduces sell pressure)

---

## Migration Notes: EVM ‚Üí Solana GameFi

| Feature | EVM (ERC-20/721) | Solana (SPL/Metaplex) | Difference |
|---------|------------------|----------------------|------------|
| **Token standard** | ERC-20 (18 decimals) | SPL Token (9 decimals) | Lower decimal precision |
| **NFT standard** | ERC-721 | Metaplex Token Metadata | Richer metadata, on-chain attributes |
| **Royalties** | ERC-2981 (optional) | Metaplex Royalty (enforced) | Marketplace enforcement stronger |
| **Minting cost** | Gas (~$5-50) | Rent + fees (~$0.01-0.10) | 100x cheaper |
| **Metadata storage** | IPFS (off-chain) | Arweave (permanent) | Better persistence |
| **Composability** | approve + transferFrom | CPI direct transfers | Simpler, safer |

**Advantages on Solana**:
1. **Sub-cent transactions**: Mint 100 NFTs for <$1 (vs. $500+ on Ethereum)
2. **Instant finality**: NFT appears in wallet within 1 second
3. **On-chain metadata**: Attributes queryable without IPFS node
4. **Native staking**: No external contracts needed (PDA vaults built-in)

---

## Deployment Checklist

### Pre-Deploy
- ‚úÖ Audit token/NFT programs (see S2.9 checklist)
- ‚úÖ Upload NFT images to Arweave (10,000 images, ~2GB)
- ‚úÖ Generate metadata JSON files (rarity distribution script)
- ‚úÖ Set up Metaplex Sugar for batch uploads

### Deploy Sequence
1. Deploy SPL tokens ($FOOD, $PAW) ‚Üí Update `.env`
2. Create Metaplex collection ‚Üí Verify creator
3. Deploy minter program ‚Üí Initialize with collection address
4. Deploy staking vault ‚Üí Fund rewards pool
5. Update game program ‚Üí Add token reward CPI calls
6. Frontend: Add token/NFT queries ‚Üí Test on devnet

### Post-Deploy
- ‚úÖ Airdrop testnet tokens (1000 $FOOD, 100 $PAW per user)
- ‚úÖ Mint 10 test NFTs (1 of each rarity) for showcase
- ‚úÖ Test full flow: Play ‚Üí Win ‚Üí Earn tokens ‚Üí Mint NFT ‚Üí Stake
- ‚úÖ Monitor: Token supply, NFT mint count, staking TVL

---

**Status**: Ready for devnet deployment  
**Next milestone**: S3.2 (Chest mechanics & loot tables)  
**Timeline**: 2 weeks (contracts 1 week, frontend 1 week)

