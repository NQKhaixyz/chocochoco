---
id: S2.11
title: "BE-16 — Backend Build & Deploy (Indexer API)"
epic: "E3 - Deploy & Ops"
sprint: "Sprint 2"
estimate: 5
labels: ["backend", "indexer", "deploy", "docs", "sprint-2"]
assignees: ["devops"]
dependencies: ["BE-15"]
status: "open"
---

## Mô tả
Chuẩn hoá build/triển khai Indexer API (Node.js + TypeScript) cho production. Đảm bảo biến môi trường đúng (RPC/PROGRAM_ID/DB), migration DB tự động, healthcheck, và hướng dẫn vận hành (Docker/PM2/systemd).

## Deliverable
- Build artifacts `indexer/dist/` 
- Health endpoints (`/health`, `/ready`)
- Database migration scripts
- Deployment guides (Docker/PM2/systemd)
- Environment templates

## Acceptance Criteria (DoD)
- `pnpm --filter @chocochoco/indexer build` thành công → sinh `dist/`
- `pnpm --filter @chocochoco/indexer start` chạy OK, `/health` trả `{ status: "ok" }`
- Migration DB: `pnpm migrate` không lỗi, tạo bảng (rounds, player_rounds, claims, treasury_fees)
- CORS configured đúng cho FE domains
- Graceful shutdown xử lý SIGTERM/SIGINT
- Documentation đầy đủ trong `indexer/README.md` + `DEPLOYMENT.md`

## Checklist

### 1. Environment Setup
- [ ] Tạo `.env.production` từ `.env.example`
- [ ] Configure Solana: `CLUSTER`, `PROGRAM_ID`, `RPC_WS_URL`, `RPC_HTTP_URL`
- [ ] Configure Database: `DATABASE_URL` (PostgreSQL khuyến nghị, SQLite dev)
- [ ] Configure Server: `PORT`, `CORS_ORIGINS`, `LOG_LEVEL`
- [ ] Configure Indexer: `AUTO_BACKFILL`, `START_SLOT`, `BATCH_SIZE`

### 2. Database Setup
- [ ] Setup PostgreSQL via Docker:
  ```bash
  docker run --name chocochoco-postgres \
    -e POSTGRES_PASSWORD=postgres \
    -e POSTGRES_DB=chocochoco_indexer \
    -p 5432:5432 -d postgres:14
  ```
- [ ] Run migrations: `pnpm --filter @chocochoco/indexer migrate`
- [ ] Verify schema: rounds, player_rounds, claims, treasury_fees tables exist
- [ ] Test rollback: `pnpm migrate:rollback`

### 3. Build & Local Test
- [ ] Build TypeScript: `pnpm --filter @chocochoco/indexer build`
- [ ] Verify `dist/` artifacts
- [ ] Test local run: `node dist/index.js`
- [ ] Check logs: DB pool init, migrations OK, API started, listener started

### 4. Health & API Endpoints
- [ ] Implement `GET /health` → `{ status: "ok", uptime: <number> }`
- [ ] Implement `GET /ready` → check DB connection + Solana RPC
- [ ] Configure CORS for FE domains
- [ ] Test endpoints với curl/Postman

### 5. Production Server
- [ ] Implement graceful shutdown (SIGTERM/SIGINT)
- [ ] Setup structured logging (Pino)
- [ ] Add error handling middleware
- [ ] Process monitoring hooks

### 6. Deployment (chọn 1)
**Option A: Docker**
- [ ] Tạo `Dockerfile` multi-stage (builder → runtime)
- [ ] Tạo `.dockerignore`
- [ ] Tạo `docker-compose.yml` (indexer + postgres)
- [ ] Test: `docker build -t chocochoco-indexer .`
- [ ] Test: `docker run -p 3001:3001 --env-file .env.production chocochoco-indexer`

**Option B: PM2**
- [ ] Install PM2: `npm install -g pm2`
- [ ] Tạo `ecosystem.config.js`
- [ ] Test: `pm2 start ecosystem.config.js`
- [ ] Setup auto-restart: `pm2 startup`

**Option C: systemd**
- [ ] Tạo `/etc/systemd/system/chocochoco-indexer.service`
- [ ] Reload: `sudo systemctl daemon-reload`
- [ ] Enable: `sudo systemctl enable chocochoco-indexer`
- [ ] Start: `sudo systemctl start chocochoco-indexer`

### 7. Testing & Validation
- [ ] Test `/health` returns OK
- [ ] Test `/ready` validates DB + RPC connections
- [ ] Verify event listening starts successfully
- [ ] Test indexing với mock/test events
- [ ] Test CORS với FE domain
- [ ] Test graceful shutdown
- [ ] Monitor memory & CPU usage

### 8. Documentation
- [ ] Update `indexer/README.md`:
  - Build instructions
  - Environment variables
  - Database setup
  - Deployment options
- [ ] Create `indexer/DEPLOYMENT.md` với step-by-step guide
- [ ] Document troubleshooting (common errors)
- [ ] Add operational runbook

## Technical Notes

### Environment Variables
```bash
# Solana
CLUSTER=devnet|testnet|mainnet-beta
PROGRAM_ID=<your_program_address>
RPC_WS_URL=wss://api.devnet.solana.com
RPC_HTTP_URL=https://api.devnet.solana.com

# Database
DATABASE_URL=postgresql://user:pass@localhost:5432/chocochoco_indexer
DB_POOL_MIN=2
DB_POOL_MAX=10

# Server
PORT=3001
NODE_ENV=production
CORS_ORIGINS=https://yourdapp.com
LOG_LEVEL=info

# Indexer
AUTO_BACKFILL=false
START_SLOT=0
BATCH_SIZE=100
```

### Health Check Example
```typescript
app.get('/health', (req, res) => {
  res.json({ status: 'ok', uptime: process.uptime() })
})

app.get('/ready', async (req, res) => {
  try {
    await db.query('SELECT 1')
    await connection.getSlot()
    res.json({ status: 'ready', database: 'connected', rpc: 'connected' })
  } catch (error) {
    res.status(503).json({ status: 'not ready', error: error.message })
  }
})
```

### Dockerfile Template
```dockerfile
FROM node:20-alpine AS builder
WORKDIR /app
COPY package*.json pnpm-lock.yaml ./
RUN npm install -g pnpm && pnpm install --frozen-lockfile
COPY . .
RUN pnpm build

FROM node:20-alpine
WORKDIR /app
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./
EXPOSE 3001
CMD ["node", "dist/index.js"]
```

## Test Cases

### Manual Test Checklist
- [ ] Build completes: `pnpm build` → `dist/` exists
- [ ] Health check: `curl http://localhost:3001/health` → `{ "status": "ok" }`
- [ ] Ready check: `curl http://localhost:3001/ready` → database + RPC connected
- [ ] Database tables: Query `\dt` in psql shows rounds, player_rounds, claims, treasury_fees
- [ ] Event listening: Logs show "Listener started", "Subscribed to program"
- [ ] CORS: FE request from allowed domain succeeds
- [ ] Graceful shutdown: `Ctrl+C` logs "Graceful shutdown complete"

### Error Cases
- **Error `28P01`** → Sai password PostgreSQL, check `DATABASE_URL`
- **Port already in use** → `lsof -i :3001` và kill process
- **RPC connection failed** → Check `RPC_HTTP_URL` và rate limits
- **Migration failed** → Check PostgreSQL running, correct credentials

## Out of Scope (Sprint 2)
- Kubernetes/autoscaling
- Advanced monitoring (Prometheus/Grafana)
- Multi-region deployment
- Helius Streams webhook
- Redis caching layer

## References
- §15 Testing (trong DESIGN.md)
- §14.1 Environment Variables
- §19.4 Deployment Output Format
- `indexer/README.md` (sẽ update)

