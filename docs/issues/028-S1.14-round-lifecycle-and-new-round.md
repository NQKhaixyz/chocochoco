---
id: S1.14
title: "Round lifecycle & tạo round mới"
epic: "E1 - Smart Contract Core"
sprint: "Sprint 1"
estimate: 3
labels: ["contract", "state-machine", "sprint-1"]
assignees: ["be1"]
dependencies: ["S1.2"]
status: "open"
---

## Context
Thiết lập state machine rõ ràng cho vòng chơi: Created → CommitOpen → RevealOpen → Settled, và tự động tạo round mới sau khi settle xong (tái dùng tham số nếu không đổi).

## Scope
- State machine và điều kiện chuyển pha theo thời gian
- Hàm khởi tạo round đầu tiên và util `_createNewRound()`
- Tạo round mới sau settle (giữ/thay đổi tham số dựa trên cấu hình admin)
- Emit `RoundCreated(id, stake, commitDeadline, revealDeadline, feeBps)`

## Acceptance Criteria
- Trạng thái chuyển đúng theo deadline và guard mỗi pha hoạt động
- Round mới được tạo sau settle; tham số khởi tạo hợp lệ
- Sự kiện RoundCreated phát mỗi khi tạo round

## Tasks
- [ ] Khai báo `Status` + deadlines trong `Round`
- [ ] Implement `_createNewRound()` đặt status và deadlines
- [ ] Chuyển pha implicit theo block time và validations
- [ ] Gọi tạo round mới ở cuối `settle`
- [ ] Unit tests: chuyển pha, tạo round mới, event

## Test Cases
- Case deadline: trước/sau commit/reveal
- Case tạo round đầu tiên và tiếp theo sau settle
- Event RoundCreated chứa đúng tham số

## Tham chiếu thiết kế
- § 4 (Theo vòng), § 7.2 (State machine), § 7.3 (API)

