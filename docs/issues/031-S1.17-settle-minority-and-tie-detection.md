---
id: S1.17
title: "Settle (xác định minority + tie detection)"
epic: "E1 - Smart Contract Core"
sprint: "Sprint 1"
estimate: 3
labels: ["contract", "settle", "sprint-1"]
assignees: ["be1"]
dependencies: ["S1.16"]
status: "open"
---

## Context
Sau `revealDeadline`, xác định phe minority dựa trên `count` và đánh dấu tie nếu bằng nhau; phát sự kiện kết thúc.

## Scope
- Guard thời gian `block.timestamp > revealDeadline`
- Tính minority từ `countMilk/countCacao`
- Đặt `status=Settled`; lưu kết quả; flag tie khi bằng nhau
- Emit `RoundMeowed(id, minority)`

## Acceptance Criteria
- Minority xác định đúng; tie được đánh dấu
- Event phát đúng dữ liệu

## Tasks
- [ ] Implement settle theo counts
- [ ] Đánh dấu tie để Claim xử lý refund
- [ ] Unit tests: tie, không ai reveal, minority rõ ràng

## Test Cases
- count bằng nhau (tie) → flag tie
- cả hai count = 0 → tie

## Tham chiếu thiết kế
- § 4 (Settle), § 7.2 (State machine), § 7.4 (Sự kiện), § 7.7 (Hòa)

