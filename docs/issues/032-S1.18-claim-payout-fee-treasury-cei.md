---
id: S1.18
title: "Claim (payout) + fee Treasury + CEI"
epic: "E1 - Smart Contract Core"
sprint: "Sprint 1"
estimate: 5
labels: ["contract", "claim", "fees", "security", "sprint-1"]
assignees: ["be1"]
dependencies: ["S1.17"]
status: "done"
---

## Context
Winner tự claim theo công thức v1; trích fee theo basis points vào Treasury trước khi phân phối; áp dụng Checks-Effects-Interactions và chống reentrancy; tie refund cho revealer.

## Scope
- Guard Settled; chặn double-claim; non-winner không được claim
- Tính payout v1: `payout = (Total - Fee) * s / M`
- Trích `Fee = feeBps/10000 * Total` vào Treasury
- Tie: revealer được refund; non-revealer theo forfeit (v1=none)
- CEI, reentrancy guard; emit `TreatClaimed`

## Acceptance Criteria
- Payout/fee chính xác; tổng claim ≤ D = Total − Fee
- Double-claim bị chặn; tie refund đúng

## Tasks
- [ ] Implement công thức payout & fee
- [ ] CEI và reentrancy guard cho claim
- [ ] Unit tests: winner/non-winner, double-claim, tie refund, rounding

## Test Cases
- Fuzz tổng claim ≤ D
- Treasury tăng đúng fee
- Double-claim revert, non-winner revert

## Tham chiếu thiết kế
- § 4 (Claim/Fee/Tie), § 7.6 (Payout & fee), § 7.9 (Bảo mật)

